#!/usr/bin/bash

foreground="#888888"
background="#000000"
font="6x10"
bat="BAT0"
interval=15

clock () {
  echo -n `date "+%a %m-%d %H:%M"`
}

usedmem () {
  echo -n `free -m | awk '/Mem/ {print $3}'`
}

totalmem () {
  echo -n `free -m | awk '/Mem/ {print $2}'`
}

volume () {
  echo -n `amixer get Master | awk '/Mono/ {print $6=="[off]"?$6:$4}'`
}

battery () {
  if [ -f "/sys/class/power_supply/$bat/charge_now" ]; then
    cur=$(cat /sys/class/power_supply/$bat/charge_now)
    full=$(cat /sys/class/power_supply/$bat/charge_full)
    echo -n "$(($cur * 100 / $full))"
  elif [ -f "/sys/class/power_supply/$bat/energy_now" ]; then
    cur=$(cat /sys/class/power_supply/$bat/energy_now)
    full=$(cat /sys/class/power_supply/$bat/energy_full)
    echo -n "$(($cur * 100 / $full))"
  else
    echo -n ``
  fi
}

cpu_temp() {
  echo -n `sensors|awk 'BEGIN{i=0;t=0;b=0}/id [0-9]/{b=$4};/Core/{++i;t+=$3}END{if(i>0){printf("%0.1f\n",t/i)}else{sub(/[^0-9.]/,"",b);print b}}'`
}

until_day_end () {
  seconds=$(($(date -d 23:59:59 +%s) - $(date +%s)))
  hours=$((seconds/60/60))
  minutes=$((seconds/60%60))
  echo -n "$hours""h""$minutes""m"
}

while true; do
  echo "%{c} [$(clock)]"\
    "- [$(until_day_end)]"\
    "- [$(usedmem)/$(totalmem)M]"\
    "- $(volume)"\
    "- [$(battery)%]"\
    "- [$(cpu_temp)]"
  sleep $interval
done | lemonbar -p \
  -F $foreground \
  -B $background \
  -f $font
